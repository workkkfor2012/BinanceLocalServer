`src\kl_server\kl_client.ts`ä¸­ï¼Œæ¯æ¬¡å»è¯·æ±‚ï¼Œ
1 å¦‚æœè¯¥å“ç§è¯¥å‘¨æœŸï¼Œå†…å­˜ä¸­æ²¡æœ‰ï¼Œä¹Ÿå°±æ˜¯klineInstance.length = 0ï¼Œé‚£ä¹ˆå°±å…¨é‡è¯·æ±‚1500æ ¹
2 å¦‚æœklineInstance.length>0,åº”è¯¥å…ˆæŸ¥çœ‹å†…å­˜ç¼“å­˜ä¸­çš„Kçº¿,è¯¥å‘¨æœŸæœ€å1æ ¹çš„opentimeï¼Œä½œä¸ºstart timeå‚æ•°ï¼Œä¼ é€’åˆ°åç«¯ï¼Œå¢é‡è¯»å–
3 è¯¥å‘¨æœŸæœ€å1æ ¹çš„opentimeï¼Œè®¡ç®—ä¸‹åˆ°å½“å‰æ—¶é—´(è¿™é‡Œå¯èƒ½æœ‰æ—¶åŒºçš„é—®é¢˜)ï¼Œä¸€å…±å¤šå°‘æ ¹ï¼Œå¦‚æœè¶…è¿‡1500æ ¹ï¼Œä¹Ÿå°±æ˜¯å†å²æ•°æ®å¤ªè€äº†ï¼Œé‚£ä¹ˆå°±åˆ é™¤æ—§çš„è¯¥å“ç§è¯¥å‘¨æœŸçš„å†…å­˜kçº¿ï¼Œç„¶åé‡æ–°å…¨é‡è¯·æ±‚

æˆ‘è§‰å¾—ä¸»è¦ä»£ç æ˜¯
1 src\kl_server\kl_client.ts
2 src\kl_server\BA_1.ts
3 src\kl_server\ONE_K.ts
4 src\_____lib\func\CycleArray.ts
ç¡®è®¤ä»¥ä¸‹é—®é¢˜
1 å¦‚ä½•è·å¾—æŸä¸ªå“ç§æŸä¸ªå‘¨æœŸçš„Kçº¿ï¼Œè¿™æ˜¯å¦è·å¾—çš„å°±æ˜¯å†…å­˜ä¸­äºŒè¿›åˆ¶çš„kçº¿æ•°æ®
2 å¦‚æœæ˜¯äºŒè¿›åˆ¶çš„å†…å­˜kçº¿æ•°æ®ï¼Œå¦‚ä½•è·å¾—è¯¥å“ç§è¯¥å‘¨æœŸçš„æœ€åä¸€æ ¹kçº¿ï¼Œå¹¶ä¸”è¯»å–å‡ºopentimeï¼Ÿ
3 è¯·æ±‚çš„å¢é‡æ•°æ®ï¼Œå¦‚ä½•mergeï¼Œç°åœ¨çš„æºç ä¸­æ˜¯å¦æœ‰ç°æˆæ–¹æ³•ï¼Œ klineInstance.set_f64(data_f64 as any);å¥½åƒæ˜¯å…¨é‡è¦†ç›–å¯¹å—ï¼Ÿ


{
    "orderId": 8389765995835764192,
    "symbol": "ETHUSDT",
    "status": "NEW",
    "clientOrderId": "OdwdlgCsbqPH1syy4nZxZB",
    "price": "3913.03",
    "avgPrice": "0.00",
    "origQty": "0.009",
    "executedQty": "0.000",
    "cumQty": "0.000",
    "cumQuote": "0.00000",
    "timeInForce": "GTC",
    "type": "LIMIT",
    "reduceOnly": false,
    "closePosition": false,
    "side": "BUY",
    "positionSide": "LONG",
    "stopPrice": "0.00",
    "workingType": "CONTRACT_PRICE",
    "priceProtect": false,
    "origType": "LIMIT",
    "priceMatch": "NONE",
    "selfTradePreventionMode": "EXPIRE_MAKER",
    "goodTillDate": 0,
    "updateTime": 1761458355914
}










[UI] Initial sync complete signal received. Triggering hot symbols load.
c_log.ts:2 2025/10/25 23:35:09  [15:35:09.722] [SyncClient:kl_client_ba3] ğŸ“¬ Rcvd FullSnapshot  | Size: 226.13 KB | Latency: 81.0ms | Port: 6444
:5173/#count=9&volume_s=30&MT4ServerIP=139.159.252.140&MT4ServerPort=6003&MT4TradeSecretKey=bsdafDcg435s12143fdgsdfg&binanceAPIKey=kWImFoYo5zv7r2cNcHGSDAXdnI41Y5r4DWwocL405xBFQNZjqaIuD83cNpWeB958&binanceSecretKey=gbsH85HUBVeGwTW8YfjrTEj7VZg8LqyqPg2TmMp3Xz7bWLLLYYmBDAS8esbuaMR2&symbolList=btcusdt&volume_pb=1000:1  Failed to fetch a worker script.
c_log.ts:2 2025/10/25 23:35:09  [15:35:09.78

export const addSymbolKline = async (symbolsToDownload: string[]) => {
        if (symbolsToDownload.length === 0) return;

        console.log(`%c[kl_client] Local Fetch: å¼€å§‹ä¸º ${symbolsToDownload.length} ä¸ªå“ç§åŠ è½½å†å²Kçº¿...`, 'color: orange; font-weight: bold;', symbolsToDownload);

        const allPeriods = [
            { interval: '1s', index: -1 },
            ...binance_kline_å‘¨æœŸ_é…ç½®.map((p, i) => ({ interval: p.interval, index: i }))
        ];

        const allRequests = symbolsToDownload.flatMap(symbol =>
            allPeriods.map(async (period) => {
                const { interval, index } = period;
                const KEY = `${symbol}_${index}`;

                if (pendingKlineRequests.has(KEY)) return;

                try {
                    pendingKlineRequests.add(KEY);
                    const klineInstance = getKline(symbol, Number(index));
                    
                    // @ts-ignore - This is a deliberate check against the main buffer.
                    if (klineInstance.ab !== (c1.realDB as ALL_K).client_ab) {
                         console.error(`[kl_client] Failed to get a valid K_Line instance for ${KEY}, likely out of memory.`);
                         return;
                    }

                    const url = `http://127.0.0.1:3000/download-binary/${symbol}/${interval}?limit=1500`;
                    const response = await fetch(url);

                    if (!response.ok) {
                        if (response.status !== 404) console.error(`[kl_client] Local Fetch: è·å– ${symbol} ${interval} å¤±è´¥, status: ${response.status}`);
                        return;
                    }

                    const ab = await response.arrayBuffer();
                    if (ab.byteLength < 48) return;

                    const view = new DataView(ab);
                    if (view.getUint32(0, false) !== 1) return;

                    const klineCount = view.getUint32(40, false);
                    if (klineCount === 0) return;

                    const data_f64: { [key: string]: Float64Array | BigInt64Array } = {};
                    const dataBodyOffset = 48;
                    const FIELD_BLOCK_SIZE = K_Line.ARR_MAX_LENGTH * 8;
                    const sortedKeys = Object.keys(klineInstance.data).sort();

                    sortedKeys.forEach((key, blockIndex) => {
                        const blockOffset = dataBodyOffset + blockIndex * FIELD_BLOCK_SIZE;
                        data_f64[key] = key === 'timestamp'
                            ? new BigInt64Array(ab, blockOffset, klineCount)
                            : new Float64Array(ab, blockOffset, klineCount);
                    });

                    klineInstance.set_f64(data_f64 as any);

                } catch (error) {
                    console.error(`[kl_client] Local Fetch: è¯·æ±‚æˆ–è§£æ ${symbol} ${interval} å¤±è´¥`, error);
                } finally {
                    pendingKlineRequests.delete(KEY);
                }
            })
        );

        await Promise.all(allRequests);
        console.log(`%c[kl_client] Local Fetch: æ‰€æœ‰æœ¬åœ°åŠ è½½ä»»åŠ¡å®Œæˆï¼Œè§¦å‘UIåˆ·æ–°ã€‚`, 'color: #4CAF50; font-weight: bold;');
        onDataUpdated();
    }


    `src\_____lib\func\CycleArray.ts`æ˜¯å‰ç«¯å­˜å‚¨Kçº¿çš„æ•°æ®ç»“æ„
`src\kl_server\kl_client.ts` æ˜¯å‰ç«¯æ“ä½œKçº¿çš„client
`src\kl_server\get_one_symbol_all_kline.ts`æ˜¯nodejsçš„åç«¯ä¸‹è½½Kçº¿çš„ä»£ç 
`src\kl_server\ONE_K.ts`æ˜¯Kçº¿å®šä¹‰

`BinanceLocalServer\src`è¿™æ˜¯æœ¬åœ°å®ç°çš„rustæœåŠ¡ï¼Œç”¨äºKçº¿ä¸‹è½½
ä»¥ä¸‹æ˜¯ä¿®æ”¹ä¸€ä¸ªç‰ˆæœ¬ä¹‹åçš„æ€»ç»“æ–‡æ¡£,ä½†æˆ‘çš„ç›®æ ‡æ˜¯ï¼Œå°½é‡ä¸è¦ä¿®æ”¹ï¼Œæˆ–è€…æå°‘ä¿®æ”¹ç°åœ¨çš„ä»£ç ï¼Œæ¥å®ç°æˆ‘ä»¬çš„ç›®çš„ï¼Œæ‰€ä»¥æˆ‘å›é€€äº†ä»£ç ç‰ˆæœ¬ï¼Œä½ å¯ä»¥é€šè¿‡ä¸€ä¸‹æ–‡æ¡£ï¼Œå¿«é€Ÿäº†è§£æˆ‘çš„ä¿®æ”¹ç›®æ ‡
æœ€æ ¸å¿ƒçš„ä¿®æ”¹æ˜¯src\kl_server\kl_client.tsä¸­çš„addSymbolKlineæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªåŠæˆå“ï¼Œä½†å¤§æ¦‚æ„æ€æœ‰

å¯ä»¥ç²—æš´ï¼Œå¯ä»¥ä¸‘é™‹ï¼Œæˆ‘çš„ç›®æ ‡ï¼Œå°½é‡çš„å°‘ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œå®ç°ä»æœ¬åœ°http://127.0.0.1:3000/download-binary/${symbol}/${interval}?limit=1500æ¥è¯·æ±‚Kçº¿
å¦‚æœä½ å‘ç°éœ€è¦åˆ†æçš„ä»£ç ï¼Œè€Œæˆ‘æ²¡æœ‰æä¾›ï¼Œè¯·åŠæ—¶å‘Šè¯‰æˆ‘ï¼Œæˆ‘æ¥è¡¥å……

____________________________________________________________________
å¥½çš„ï¼Œè¿™æ¬¡æˆ‘ä»¬ä¸€èµ·å®Œæˆäº†ä¸€æ¬¡é‡è¦çš„æ¶æ„é‡æ„ï¼Œå°†å‰ç«¯çš„Kçº¿æ•°æ®æºä»åç«¯WebSocketæ¨é€åˆ‡æ¢åˆ°äº†å‰ç«¯ä¸»åŠ¨ä»æœ¬åœ°RustæœåŠ¡æ‹‰å–ã€‚

ä»¥ä¸‹æ˜¯æˆ‘ä»¬è¿™æ¬¡å¯¹è¯çš„ä¸»è¦ä¿®æ”¹æ€»ç»“ï¼š

æ ¸å¿ƒç›®æ ‡

å°†å‰ç«¯è·å–å†å²Kçº¿çš„æ–¹å¼ï¼Œä»ä¾èµ–åç«¯ ba_1 WebSocket çš„ FullSnapshot æ¨é€ï¼Œå½»åº•è½¬å˜ä¸ºå‰ç«¯è‡ªæˆ‘ç®¡ç†ã€ä¸»åŠ¨ä»æœ¬åœ°RustæœåŠ¡ (127.0.0.1:3000) æ‹‰å–çš„æ¨¡å¼ã€‚

æ¶æ„å†³ç­–ä¸æ¼”è¿›

åˆæ­¥å°è¯•: æœ€åˆçš„æ€è·¯æ˜¯è®©æœ¬åœ°RustæœåŠ¡ç”Ÿæˆä¸åç«¯ FullSnapshot å®Œå…¨ç›¸åŒçš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œç„¶åå‰ç«¯é€šè¿‡ merge_snapshot æ–¹æ³•åŠ è½½ã€‚

å‘ç°é—®é¢˜: è¿™ç§æ–¹å¼è€¦åˆåº¦å¤ªé«˜ï¼ŒRustæœåŠ¡éœ€è¦æ¨¡æ‹Ÿ CycleArray çš„å†…éƒ¨å®ç°ï¼ˆå¦‚ pos, size ç­‰ï¼‰ï¼Œéå¸¸å¤æ‚ä¸”æ˜“é”™ã€‚

æ”¹è¿›æ–¹æ¡ˆ: å†³å®šè®©RustæœåŠ¡åªæä¾›çº¯ç²¹çš„ã€åˆ—å¼å­˜å‚¨ï¼ˆStruct of Arraysï¼‰çš„äºŒè¿›åˆ¶æ•°æ®ã€‚å‰ç«¯åˆ™é€šè¿‡ fetch è·å– ArrayBufferï¼Œç„¶åè§£æå¹¶è°ƒç”¨ CycleArray æä¾›çš„æ›´é«˜çº§æ¥å£ set_f64 æ¥å¡«å……æ•°æ®ã€‚

å‘ç°é—®é¢˜: set_f64 éœ€è¦ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ K_Line å®ä¾‹ï¼Œä½†åœ¨æ–°æ¶æ„ä¸‹ï¼Œæ²¡æœ‰ä»»ä½•æœºåˆ¶æ¥åˆ›å»ºè¿™ä¸ªå®ä¾‹ï¼Œå¯¼è‡´äº†â€œæ— æ³•æ‰¾åˆ°K_Lineå®ä¾‹â€çš„é”™è¯¯ã€‚

æœ€ç»ˆæ–¹æ¡ˆ (å‰ç«¯è‡ªæˆ‘ç®¡ç†): æ—¢ç„¶å‰ç«¯æ˜¯æ•°æ®çš„ä½¿ç”¨è€…ï¼Œé‚£å°±è®©å‰ç«¯æˆä¸ºæ•°æ®çš„æ‰€æœ‰è€…å’Œç®¡ç†è€…ã€‚

å‰ç«¯è´Ÿè´£å†…å­˜åˆ†é…: åœ¨ kl_client åˆå§‹åŒ–æ—¶ï¼Œæ¨¡ä»¿åç«¯æœåŠ¡å™¨çš„é€»è¾‘ï¼Œä¸€æ¬¡æ€§åˆ›å»ºä¸€ä¸ªå·¨å¤§çš„ã€è¶³ä»¥å®¹çº³æ‰€æœ‰Kçº¿æ•°æ®çš„ ArrayBufferã€‚

å‰ç«¯è´Ÿè´£å®ä¾‹åˆ›å»º: kl_client çš„ getKline æ–¹æ³•è¢«èµ‹äºˆæ–°èŒè´£ï¼šå½“è¯·æ±‚ä¸€ä¸ªä¸å­˜åœ¨çš„ K_Line å®ä¾‹æ—¶ï¼Œå®ƒä¼šåœ¨è‡ªå·±ç®¡ç†çš„ ArrayBuffer ä¸ŠåŠ¨æ€åœ°åˆ†é…ä¸€å—å†…å­˜ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ K_Line å®ä¾‹è¿”å›ã€‚

å‰ç«¯è´Ÿè´£æ•°æ®åŠ è½½: addSymbolKline æ–¹æ³•ç°åœ¨å¯ä»¥å®‰å…¨åœ°è°ƒç”¨ getKline è·å–ï¼ˆæˆ–åˆ›å»ºï¼‰å®ä¾‹ï¼Œç„¶åä»æœ¬åœ°RustæœåŠ¡æ‹‰å–æ•°æ®å¹¶é€šè¿‡ set_f64 å¡«å……è¿›å»ã€‚

è§£è€¦WebSocket: å‰ç«¯ä¸å†éœ€è¦è¿æ¥ ba_1 WebSocketé€šé“æ¥è·å–Kçº¿ï¼Œå½»åº•è§£è€¦ã€‚ba_2ï¼ˆåˆçº¦ä¿¡æ¯ï¼‰å’Œ ba_3ï¼ˆç»Ÿè®¡æ•°æ®ï¼‰çš„è¿æ¥ä¿æŒä¸å˜ã€‚

ä¸»è¦æ–‡ä»¶ä¿®æ”¹è¯¦æƒ…

BinanceLocalServer/src/transformer.rs (Rust ç«¯)

ä¿®æ­£äº†äºŒè¿›åˆ¶æ ¼å¼: è°ƒæ•´äº† klines_to_binary_blob å‡½æ•°ï¼Œä½¿å…¶ç”Ÿæˆçš„äºŒè¿›åˆ¶æ•°æ®ä¸¥æ ¼æŒ‰ç…§å‰ç«¯ CycleArray å†…éƒ¨å­—æ®µå­—æ¯æ’åºåçš„é¡ºåºï¼ˆclose, ext_..., high, low, open, timestamp, æˆäº¤é¢ï¼‰æ¥å¸ƒå±€å†…å­˜ã€‚

è¡¥é½äº†å­—æ®µ: å¢åŠ äº†å‰ç«¯éœ€è¦çš„ä½†APIæ²¡æœ‰è¿”å›çš„ ext_ å­—æ®µï¼Œå¹¶ç”¨ 0.0 å¡«å……ã€‚

src/kl_server/BA_1.ts (å‰ç«¯ RealDB)

ä¸ºå®¢æˆ·ç«¯æ¨¡å¼èµ‹èƒ½: ä¸º ALL_K ç±»å¢åŠ äº† client_useBuffer æ–¹æ³•ï¼Œå…è®¸å¤–éƒ¨ï¼ˆkl_clientï¼‰æ³¨å…¥ä¸€ä¸ª ArrayBufferã€‚

å®ç°å®ä¾‹åŠ¨æ€åˆ›å»º: ä¿®æ”¹äº† get_kline æ–¹æ³•ï¼Œåœ¨å®¢æˆ·ç«¯æ¨¡å¼ä¸‹ï¼Œå¦‚æœ Map ä¸­æ‰¾ä¸åˆ°å®ä¾‹ï¼Œä¼šè°ƒç”¨ client_getOrCreateKline åœ¨ client_ab ä¸Šåˆ›å»ºæ–°çš„ K_Line å®ä¾‹ã€‚

æ¸…ç†è¿‡æ—¶é€»è¾‘: åºŸå¼ƒäº†å®¢æˆ·ç«¯çš„ set__all, merge_snapshot ç­‰ä¾èµ–WebSocketæ¨é€çš„æ–¹æ³•ã€‚

src/kl_server/kl_client.ts (å‰ç«¯æ ¸å¿ƒ)

æˆä¸ºå†…å­˜ç®¡ç†è€…: connect æ–¹æ³•ç°åœ¨è´Ÿè´£è®¡ç®—å¹¶åˆ›å»ºå‰ç«¯Kçº¿æ•°æ®æ‰€éœ€çš„æ€» ArrayBufferï¼Œå¹¶å°†å…¶æ³¨å…¥ c1.realDBã€‚

æ–­å¼€WebSocketä¾èµ–: ç§»é™¤äº†æ‰€æœ‰è¿æ¥ ba_1 å’Œ c1_hp çš„ä»£ç ï¼Œä»¥åŠç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨ã€‚

å®Œå–„æ•°æ®åŠ è½½: addSymbolKline æˆä¸ºä»æœ¬åœ°RustæœåŠ¡åŠ è½½å†å²æ•°æ®çš„å”¯ä¸€å…¥å£ï¼Œå…¶å†…éƒ¨é€»è¾‘ç°åœ¨å¯ä»¥å®‰å…¨åœ°è·å–æˆ–åˆ›å»º K_Line å®ä¾‹ã€‚

ä¿®å¤ç¼–è¯‘é”™è¯¯: è¡¥å…¨äº†è¢«é—æ¼çš„ getTurnoverTop15 ç­‰å‡½æ•°ï¼Œè§£å†³äº†æ‰€æœ‰ç¼–è¯‘é—®é¢˜ã€‚

src/kl_server/servers.ts (åç«¯æœåŠ¡)

ç²¾ç®€æœåŠ¡: ç§»é™¤äº†ä¸ºKçº¿æµå¼ä¼ è¾“è€Œè®¾è®¡çš„ baServer1_highPriority é«˜ä¼˜å…ˆçº§é€šé“ï¼Œå› ä¸ºå®ƒåœ¨æ–°æ¶æ„ä¸‹å·²æ— ç”¨æ­¦ä¹‹åœ°ã€‚ä¿ç•™äº† baServer1 ä½œä¸ºæœªæ¥å¯èƒ½çš„é€šç”¨æ¨é€é€šé“ã€‚

src/index.tsx & src/client/CustomCell.tsx (UIå±‚)

ç®€åŒ–è°ƒç”¨: ç§»é™¤äº†å¯¹ addSubscriptions çš„è°ƒç”¨ï¼Œç°åœ¨æ‰€æœ‰Kçº¿åŠ è½½è¯·æ±‚éƒ½ç»Ÿä¸€é€šè¿‡ addSymbolKline å‘èµ·ã€‚

æœ€ç»ˆæˆæœ

æˆ‘ä»¬æˆåŠŸåœ°å°†Kçº¿æ•°æ®çš„ç®¡ç†æƒä»åç«¯è½¬ç§»åˆ°äº†å‰ç«¯ï¼Œå®ç°äº†ä¸€ä¸ªæ›´ç‹¬ç«‹ã€æ›´æ¸…æ™°ã€é«˜æ€§èƒ½çš„å‰ç«¯æ•°æ®å±‚ã€‚å‰ç«¯ç°åœ¨å¯ä»¥ç‹¬ç«‹äºåç«¯WebSocketæœåŠ¡æ¥å±•ç¤ºå’Œæ“ä½œå†å²Kçº¿ï¼Œä¸ºåç»­ç›´æ¥é›†æˆå¸å®‰å®æ—¶WebSocketæµå¥ å®šäº†åšå®çš„åŸºç¡€ã€‚æ•´ä¸ªè¿‡ç¨‹ä¹Ÿä½“ç°äº†ä»å‘ç°é—®é¢˜ã€åˆ†ææ ¹æºåˆ°é€æ­¥è¿­ä»£å‡ºæœ€ç»ˆè§£å†³æ–¹æ¡ˆçš„å®Œæ•´æ€è€ƒè·¯å¾„ã€‚


`src\kl_server\kl_client.ts`ç°åœ¨çš„kçº¿æ˜¯é€šè¿‡addSymbolKlineæ–¹æ³•å‘æœ¬åœ°çš„æœåŠ¡è¯·æ±‚çš„ï¼Œä½†ç›®å‰çš„è¯·æ±‚éå¸¸çš„ç²—æ”¾ï¼Œæ¯æ¬¡éƒ½æ˜¯è¯·æ±‚1500æ ¹Kçº¿ï¼Œå¤ªä¸ä¼˜é›…äº†ï¼Œæ‰€ä»¥æˆ‘éœ€è¦åœ¨å‰ç«¯å®ç°ä¸€ä¸ªindexdb